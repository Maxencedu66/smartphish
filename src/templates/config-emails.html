{% extends "index.html" %}
{% block title %}Configuration Emails - SmartPhish{% endblock %}

{% block content %}
<h2>⚙️ Configuration</h2>

<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_groups') }}">Groupes</a></li>
    <li class="nav-item"><a class="nav-link active" href="{{ url_for('frontend.config_emails') }}">Email Templates</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_landing_pages') }}">Landing Pages</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_smtp') }}">Sending Profile</a></li>
</ul>

<h3>📩 Gestion des Email Templates</h3>

<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#newEmailTemplateModal">➕ Nouveau Template</button>

<table class="table table-striped">
    <thead>
        <tr><th>Nom</th><th>Sujet</th><th>Actions</th></tr>
    </thead>
    <tbody id="emailTemplateTableBody">
        {% for template in email_templates %}
        <tr>
            <td>{{ template.name }}</td>
            <td>{{ template.subject }}</td>
            <td>
                <button class="btn btn-primary btn-sm edit-template" data-id="{{ template.id }}" data-bs-toggle="modal" data-bs-target="#editEmailTemplateModal">✏️ Modifier</button>
                <button class="btn btn-danger btn-sm delete-template" data-id="{{ template.id }}">🗑️ Supprimer</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ========== MODAL: CREATE NEW EMAIL TEMPLATE ========== -->
<div class="modal fade" id="newEmailTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Créer un Email Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="newTemplateName" class="form-label">Nom :</label>
                <input type="text" id="newTemplateName" class="form-control mb-2" required>

                <label for="newEmailSubject" class="form-label">Sujet :</label>
                <input type="text" id="newEmailSubject" class="form-control mb-2" required>

                <label for="newEmailText" class="form-label">Contenu :</label>
                <textarea id="newEmailText" class="form-control" rows="5" required></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="submitNewEmailTemplate()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODAL: EDIT EMAIL TEMPLATE ========== -->
<div class="modal fade" id="editEmailTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier un Email Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTemplateId">
                
                <label for="editTemplateName" class="form-label">Nom :</label>
                <input type="text" id="editTemplateName" class="form-control mb-2" required>

                <label for="editEmailSubject" class="form-label">Sujet :</label>
                <input type="text" id="editEmailSubject" class="form-control mb-2" required>

                <label for="editEmailText" class="form-label">Contenu :</label>
                <textarea id="editEmailText" class="form-control" rows="5" required></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitEditedEmailTemplate()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Récupérer les boutons Modifier après chargement de la page
    document.querySelectorAll(".edit-template").forEach(btn => {
        btn.addEventListener("click", function() {
            const templateId = this.getAttribute("data-id");

            fetch(`/templates/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.error) {
                        alert("Erreur lors de la récupération du template.");
                        return;
                    }

                    document.getElementById("editTemplateId").value = data.id;
                    document.getElementById("editTemplateName").value = data.name;
                    document.getElementById("editEmailSubject").value = data.subject;
                    document.getElementById("editEmailText").value = data.text || "";
                })
                .catch(err => console.error("Erreur lors du chargement du template :", err));
        });
    });
});

// Création d'un nouveau template
function submitNewEmailTemplate() {
    const data = {
        name: document.getElementById("newTemplateName").value,
        subject: document.getElementById("newEmailSubject").value,
        text: document.getElementById("newEmailText").value
    };

    fetch("/templates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(err => console.error(err));
}

// Modification d'un template
function submitEditedEmailTemplate() {
    const templateId = document.getElementById("editTemplateId").value;
    const data = {
        id: parseInt(templateId, 10),
        name: document.getElementById("editTemplateName").value,
        subject: document.getElementById("editEmailSubject").value,
        text: document.getElementById("editEmailText").value
    };

    fetch(`/templates/${templateId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(err => console.error(err));
}

// Suppression d'un template
document.querySelectorAll(".delete-template").forEach(btn => {
    btn.addEventListener("click", function() {
        const templateId = this.getAttribute("data-id");

        if (!confirm("Voulez-vous vraiment supprimer cet Email Template ?")) return;

        fetch(`/templates/${templateId}`, {
            method: "DELETE"
        })
        .then(res => res.json())
        .then(() => location.reload())
        .catch(err => console.error("Erreur lors de la suppression :", err));
    });
});
</script>

{% endblock %}
