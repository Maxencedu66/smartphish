{% extends "index.html" %}
{% block title %}Configuration Emails - SmartPhish{% endblock %}

{% block content %}
<h2>‚öôÔ∏è Configuration</h2>

<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_groups') }}">Groupes</a></li>
    <li class="nav-item"><a class="nav-link active" href="{{ url_for('frontend.config_emails') }}">Mod√®les d'e-mails</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_landing_pages') }}">Page de destination</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_smtp') }}">Profil d'envoi</a></li>
</ul>

<h3>üì© Gestion des mod√®les d'e-mails</h3>

<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#newEmailTemplateModal">‚ûï Nouveau Mod√®les</button>

<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr>
                <th>Nom</th>
                <th>Sujet</th>
                <th class="text-end"></th>
            </tr>
        </thead>
        <tbody id="emailTemplateTableBody">
            {% for template in email_templates %}
            <tr>
                <td>{{ template.name }}</td>
                <td>{{ template.subject }}</td>
                <td class="text-end">
                    <button class="btn btn-primary btn-sm edit-template" data-id="{{ template.id }}" data-bs-toggle="modal" data-bs-target="#editEmailTemplateModal">‚úèÔ∏è Modifier</button>
                    <button class="btn btn-danger btn-sm delete-template" data-id="{{ template.id }}">üóëÔ∏è Supprimer</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ========== MODAL: CREATE NEW EMAIL TEMPLATE ========== -->
<div class="modal fade" id="newEmailTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Cr√©er un mod√®le d'e-mails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newEmailTemplateForm">
                    <div class="mb-3">
                        <label for="newTemplateName" class="form-label">Nom :</label>
                        <input type="text" id="newTemplateName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√©thode de cr√©ation :</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="creationMethod" id="manualMethod" value="manual" checked>
                                <label class="form-check-label" for="manualMethod">Manuel</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="creationMethod" id="aiMethod" value="ai">
                                <label class="form-check-label" for="aiMethod">G√©n√©ration par IA</label>
                            </div>
                        </div>
                    </div>
                    <!-- Champs pour saisie manuelle -->
                    <div id="manualFields">
                        <div class="mb-3">
                            <label for="newEmailSubject" class="form-label">Sujet :</label>
                            <input type="text" id="newEmailSubject" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Format :</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="emailFormat" id="textFormat" value="text" checked>
                                <label class="form-check-label" for="textFormat">Texte</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="emailFormat" id="htmlFormat" value="html">
                                <label class="form-check-label" for="htmlFormat">HTML</label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="textEditor">
                            <label for="newEmailText" class="form-label">Contenu :</label>
                            <textarea id="newEmailText" class="form-control" rows="5" required></textarea>
                        </div>
                        
                        <div class="mb-3" id="htmlEditor" style="display:none;">
                            <label for="newEmailHtml" class="form-label">Contenu HTML :</label>
                            <div id="quillEditor" style="height: 250px;"></div>
                            <input type="hidden" id="newEmailHtml">

                        </div>
                    </div>
                    <!-- Champs pour g√©n√©ration par IA -->
                    <div id="aiFields" style="display:none;">
                        <div class="mb-3">
                            <label for="aiScenario" class="form-label">Choisissez un sc√©nario :</label>
                            <select id="aiScenario" class="form-select">
                                <option value="">-- S√©lectionnez --</option>
                                <option value="D√©part √† la retraite">D√©part √† la retraite</option>
                                <option value="Erreur de paiement - RIB n√©cessaire">Erreur de paiement</option>
                                <option value="Invitation √† un √©v√©nement exclusif">Invitation √† un √©v√©nement exclusif</option>
                                <option value="Mise √† jour de s√©curit√© urgente">Mise √† jour de s√©curit√© urgente</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="aiEntreprise" class="form-label">Nom de l'entreprise :</label>
                            <input type="text" id="aiEntreprise" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="aiExpediteur" class="form-label">Nom de l'exp√©diteur :</label>
                            <input type="text" id="aiExpediteur" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="aiEmailExpediteur" class="form-label">Email exp√©diteur :</label>
                            <input type="email" id="aiEmailExpediteur" class="form-control">
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary" onclick="generateAIEmail()">G√©n√©rer l'email par IA</button>
                        </div>
                        <!-- Spinner de chargement -->
                        <div id="aiLoading" style="display: none;" class="text-center mt-2">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        <!-- R√©sultat de l'IA avec bouton R√©g√©n√©rer -->
                        <div id="aiResult" style="display:none;">
                            <h5>Email g√©n√©r√©</h5>
                            <div class="mb-3">
                                <label for="aiGeneratedSubject" class="form-label">Sujet g√©n√©r√© :</label>
                                <input type="text" id="aiGeneratedSubject" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="aiGeneratedContent" class="form-label">Contenu g√©n√©r√© :</label>
                                <textarea id="aiGeneratedContent" class="form-control" required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning" onclick="generateAIEmail()">R√©g√©n√©rer</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="submitNewEmailTemplate()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODAL: EDIT EMAIL TEMPLATE ========== -->
<div class="modal fade" id="editEmailTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Modifier un mod√®le d'e-mails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTemplateId">
                <div class="mb-3">
                    <label for="editTemplateName" class="form-label">Nom :</label>
                    <input type="text" id="editTemplateName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="editEmailSubject" class="form-label">Sujet :</label>
                    <input type="text" id="editEmailSubject" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Format :</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="editEmailFormat" id="editTextFormat" value="text" checked>
                        <label class="form-check-label" for="editTextFormat">Texte</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="editEmailFormat" id="editHtmlFormat" value="html">
                        <label class="form-check-label" for="editHtmlFormat">HTML</label>
                    </div>
                </div>
                

                <!-- Texte brut -->
                <div class="mb-3" id="editTextEditor">
                    <label for="editEmailText" class="form-label">Contenu :</label>
                    <textarea id="editEmailText" class="form-control" rows="5"></textarea>
                </div>

                <!-- HTML avec Quill -->
                <div class="mb-3" id="editHtmlEditor" style="display: none;">
                    <label for="editEmailHtml" class="form-label">Contenu HTML :</label>
                    <div id="editQuillEditor" style="height: 250px;"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitEditedEmailTemplate()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Quill CDN -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>

function validateEmailTemplateForm(nameId, subjectId, textId) {
    const selectedMethod = document.querySelector('input[name="creationMethod"]:checked').value;
    let text, plaintext;

    if (selectedMethod === "manual") {
        const name = document.getElementById(nameId).value.trim();
        const subject = document.getElementById(subjectId).value.trim();
        
        if (document.getElementById("htmlFormat").checked) {
            text = quill.root.innerHTML.trim();
            plaintext = quill.getText().trim();
        } else if (document.getElementById("textFormat").checked) {
            plaintext = document.getElementById(textId).value.trim();
        }

        const isValidRequiredFields = validateRequiredFields([
            [name, "Nom du mod√®le"],
            [subject, "Sujet Email"],
            [plaintext, "Contenu Email"]
        ]);
        if (!isValidRequiredFields) return;
    } else if (selectedMethod === "ai") {
        const name = document.getElementById(nameId).value.trim();
        let subject, textia;
        const scenario = document.getElementById("aiScenario").value.trim();
        const company  = document.getElementById("aiEntreprise").value.trim();
        const sender   = document.getElementById("aiExpediteur").value.trim();
        const email    = document.getElementById("aiEmailExpediteur").value.trim();
        subject = document.getElementById("aiGeneratedSubject").value.trim();
        textia  = document.getElementById("aiGeneratedContent").value.trim();



        const isValidRequiredFields = validateRequiredFields([
            [name, "Nom du mod√®le"],
            [scenario, "Sc√©nario"],
            [company, "Nom de l'entreprise"],
            [sender, "Nom de l'exp√©diteur"],
            [email, "Email de l'exp√©diteur"],
            [subject, "Sujet g√©n√©r√©"],
            [textia, "Contenu g√©n√©r√©"]
        ]);
        if (!isValidRequiredFields) return;

        if (!isValidEmail(email)) {
            Swal.fire({
                icon: "warning",
                title: "Email de l'exp√©diteur invalide",
                text: "Veuillez saisir une adresse email valide pour l'exp√©diteur.",
                confirmButtonColor: "#f39c12"
            });
            return false;
        }
    } else {
        Swal.fire({
            icon: "error",
            title: "Erreur",
            text: "M√©thode de cr√©ation non reconnue.",
            confirmButtonColor: "#d33"
        });
        return false;
    }

    return true;
}

let quill;
let editQuillEditor;

document.addEventListener("DOMContentLoaded", function() {
    // Initialisation de l'√©diteur Quill
    quill = new Quill('#quillEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline', 'link'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['clean']
            ]
        }
    });

    // G√©rer le switch entre mode texte / HTML
    document.querySelectorAll('input[name="emailFormat"]').forEach((radio) => {
        radio.addEventListener('change', function () {
            if (this.value === "html") {
                document.getElementById("textEditor").style.display = "none";
                document.getElementById("htmlEditor").style.display = "block";
            } else {
                document.getElementById("textEditor").style.display = "block";
                document.getElementById("htmlEditor").style.display = "none";
            }
        });
    });

    // Initialisation de l'√©diteur Quill pour l'√©dition
    editQuill = new Quill('#editQuillEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline', 'link'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['clean']
            ]
        }
    });

    // G√©rer le switch entre mode texte / HTML pour l'√©dition
    document.querySelectorAll('input[name="editEmailFormat"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const isHtml = document.getElementById("editHtmlFormat").checked;
            document.getElementById("editTextEditor").style.display = isHtml ? "none" : "block";
            document.getElementById("editHtmlEditor").style.display = isHtml ? "block" : "none";
        });
    });

    // Basculement entre les champs manuels et IA
    document.getElementsByName("creationMethod").forEach(radio => {
        radio.addEventListener("change", function() {
            if (this.value === "ai") {
                document.getElementById("aiFields").style.display = "block";
                document.getElementById("manualFields").style.display = "none";
            } else {
                document.getElementById("aiFields").style.display = "none";
                document.getElementById("manualFields").style.display = "block";
            }
        });
    });

    // Modification d'un template
    document.querySelectorAll(".edit-template").forEach(btn => {
        btn.addEventListener("click", function() {
            const templateId = this.getAttribute("data-id");
            fetch(`/templates/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.error) {
                        alert("Erreur lors de la r√©cup√©ration du mod√®le.");
                        return;
                    }
                    document.getElementById("editTemplateId").value = data.id;
                    document.getElementById("editTemplateName").value = data.name;
                    document.getElementById("editEmailSubject").value = data.subject;
                    document.getElementById("editEmailText").value = data.text || "";
                })
                .catch(err => console.error("Erreur lors du chargement du mod√®le :", err));
        });
    });

    // Suppression d'un template
    document.querySelectorAll(".delete-template").forEach(btn => {
        btn.addEventListener("click", function() {
        const templateId = this.getAttribute("data-id");
        Swal.fire({
            title: "Supprimer ce mod√®le d'e-mails ?",
            text: "Cette action est irr√©versible. Voulez-vous continuer ?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Oui, supprimer",
            cancelButtonText: "Annuler",
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
            // Si l'utilisateur confirme, on envoie la requ√™te DELETE
            fetch(`/templates/${templateId}`, {
                method: "DELETE"
            })
            .then(res => res.json())
            .then(() => {
                Swal.fire({
                title: "Supprim√© !",
                text: "Le mod√®le d'e-mails a √©t√© supprim√© avec succ√®s.",
                icon: "success",
                timer: 2000,
                showConfirmButton: false
                }).then(() => {
                location.reload();
                });
            })
            .catch(err => {
                console.error("Erreur lors de la suppression :", err);
                Swal.fire("Erreur", "Une erreur s'est produite lors de la suppression.", "error");
            });
            }
        });
        });
    });
});

// Fonction pour g√©n√©rer l'email par IA avec affichage de la roue de chargement
function generateAIEmail() {
    const scenario = document.getElementById("aiScenario").value;
    const entreprise = document.getElementById("aiEntreprise").value;
    const expediteur = document.getElementById("aiExpediteur").value;
    const email_expediteur = document.getElementById("aiEmailExpediteur").value;

    const isValidRequiredFields = validateRequiredFields([
        [scenario, "Sc√©nario"],
        [entreprise, "Nom de l'entreprise"],
        [expediteur, "Nom de l'exp√©diteur"],
        [email_expediteur, "Email de l'exp√©diteur"]
    ]);
    if (!isValidRequiredFields) return;

    if (!isValidEmail(email_expediteur)) {
        Swal.fire({
            icon: "warning",
            title: "Email de l'exp√©diteur invalide",
            text: "Veuillez saisir une adresse email valide pour l'exp√©diteur.",
            confirmButtonColor: "#f39c12"
        });
        return false;
    }

     // Affiche une popup bloquante jusqu'√† la fin du chargement
     Swal.fire({
        title: "G√©n√©ration en cours...",
        text: "Merci de patienter.",
        allowOutsideClick: false,
        allowEscapeKey: false,
        allowEnterKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Change the text after 5 seconds
    let timeout = setTimeout(() => {
        Swal.update({
            text: "Plus que quelques secondes..."
        });
        Swal.showLoading();
    }, 8000);

    
    // Afficher le spinner et masquer le r√©sultat pr√©c√©dent
    // document.getElementById("aiLoading").style.display = "block";
    document.getElementById("aiResult").style.display = "none";

    fetch("/generate-email", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            scenario: scenario,
            entreprise: entreprise,
            expediteur: expediteur,
            email_expediteur: email_expediteur
        })
    })
    .then(response => response.json())
    .then(data => {
        //document.getElementById("aiLoading").style.display = "none";
        clearTimeout(timeout);
        Swal.close(); // Ferme la popup de chargement
        if (data.error) {
            Swal.fire({
                icon: "error",
                title: "Erreur",
                text: "Erreur lors de la g√©n√©ration de l'email : " + data.error,
                confirmButtonColor: "#d33"
            });
            return;
        }
        // Remplir les champs de l'IA avec l'email g√©n√©r√© et afficher le r√©sultat
        document.getElementById("aiGeneratedSubject").value = data.object;
        document.getElementById("aiGeneratedContent").value = data.content;
        document.getElementById("aiResult").style.display = "block";

        // Ajuste la hauteur du textarea pour le contenu g√©n√©r√©
        const textarea = document.getElementById("aiGeneratedContent");
        textarea.style.height = "1px";
        textarea.style.height = (4 + textarea.scrollHeight) + "px";
        // Fait d√©filer la page pour afficher le contenu g√©n√©r√© 
        document.getElementById("aiResult").scrollIntoView({ behavior: 'smooth', block: 'center' });
    })
    .catch(err => {
        Swal.close();
        console.error("Erreur lors de la g√©n√©ration par IA:", err);
        Swal.fire({
            icon: "error",
            title: "Erreur serveur",
            text: "Une erreur s'est produite lors de la g√©n√©ration de l'email.",
            confirmButtonColor: "#d33"
        });
    });
}

// Fonction pour soumettre le nouveau template
function submitNewEmailTemplate() {
    const name = document.getElementById("newTemplateName").value;
    let subject, text;
    let method;    

    if (document.getElementById("aiMethod").checked) {
        subject = document.getElementById("aiGeneratedSubject").value;
        text = document.getElementById("aiGeneratedContent").value;
    } else if (document.getElementById("manualMethod").checked) {
        subject = document.getElementById("newEmailSubject").value;
        if (document.getElementById("htmlFormat").checked) {
            text = quill.root.innerHTML;
            method = "quillEditor";
        } else {
            text = document.getElementById("newEmailText").value;
            method = "newEmailText";
        }
    } else {
        Swal.fire({
            icon: "error",
            title: "Erreur",
            text: "M√©thode de cr√©ation non reconnue.",
            confirmButtonColor: "#d33"
        });
        return false;
    }

    if (!validateEmailTemplateForm("newTemplateName", "newEmailSubject", method)) {
        return;
    }

    const data = {
        name: name,
        subject: subject,
        text: text
    };

    fetch("/templates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.error) {
            Swal.fire({
                icon: "error",
                title: "Erreur lors de l'ajout",
                text: response.error,
                confirmButtonColor: "#d33"
            });
        } else {
            Swal.fire({
                icon: "success",
                title: "Mod√®le ajout√© !",
                text: "Le mod√®le d'e-mail a √©t√© enregistr√© avec succ√®s.",
                confirmButtonColor: "#28a745"
            }).then(() => {
                location.reload();
            });
        }
    })
    .catch(err => {
        console.error("Erreur:", err);
        Swal.fire({
            icon: "error",
            title: "Erreur serveur",
            text: "Une erreur s'est produite lors de la cr√©ation du mod√®le.",
            confirmButtonColor: "#d33"
        });
    });
}

// Validit√© du formulaire EDIT
function validateEditEmailTemplateForm() {
    const name = document.getElementById("editTemplateName").value.trim();
    const subject = document.getElementById("editEmailSubject").value.trim();
    
    let text, plaintext;
    if (document.getElementById("editHtmlFormat").checked) {
        text = editQuill.root.innerHTML.trim();
        plaintext = editQuill.getText().trim();
    } else if (document.getElementById("editTextFormat").checked) {
        plaintext = document.getElementById("editEmailText").value.trim();
    } else {
        Swal.fire({
            icon: "error",
            title: "Erreur",
            text: "Format de contenu non reconnu.",
            confirmButtonColor: "#d33"
        });
        return false;
    }

    const isValidRequiredFields = validateRequiredFields([
        [name, "Nom du mod√®le"],
        [subject, "Sujet Email"],
        [plaintext, "Contenu Email"]
    ]);

    if (!isValidRequiredFields) return;

    return true;
}


// Fonction pour soumettre la modification d'un template
function submitEditedEmailTemplate() {
    const templateId = document.getElementById("editTemplateId").value;
    const name = document.getElementById("editTemplateName").value.trim();
    const subject = document.getElementById("editEmailSubject").value.trim();
    let text;

    if (document.getElementById("editHtmlFormat").checked) {
        text = editQuill.root.innerHTML.trim();
    } else {
        text = document.getElementById("editEmailText").value.trim();
    }

    const data = {
        id: parseInt(templateId, 10),
        name,
        subject,
        text
    };

    if (!validateEditEmailTemplateForm()) {
        return;
    }

    fetch(`/templates/${templateId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.error) {
            Swal.fire({
                icon: "error",
                title: "Erreur",
                text: response.error,
                confirmButtonColor: "#d33"
            });
        } else {
            Swal.fire({
                icon: "success",
                title: "Mod√®le mis √† jour !",
                text: "Les modifications ont √©t√© enregistr√©es avec succ√®s.",
                confirmButtonColor: "#28a745"
            }).then(() => {
                location.reload();
            });
        }
    })
    .catch(err => {
        Swal.close();
        console.error("Erreur:", err);
        Swal.fire({
            icon: "error",
            title: "Erreur serveur",
            text: "Une erreur s'est produite lors de la mise √† jour.",
            confirmButtonColor: "#d33"
        });
    });
}

</script>

{% endblock %}
