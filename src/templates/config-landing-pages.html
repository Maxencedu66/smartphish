{% extends "index.html" %}
{% block title %}Configuration Landing Pages - SmartPhish{% endblock %}

{% block content %}
<h2>‚öôÔ∏è Configuration</h2>

<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_groups') }}">Groupes</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_emails') }}">Mod√®les d'e-mails</a></li>
    <li class="nav-item"><a class="nav-link active" href="{{ url_for('frontend.config_landing_pages') }}">Page de destination</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.config_smtp') }}">Profil d'envoi</a></li>
</ul>

<h3>üìÑ Gestion des Pages de destination</h3>

<!-- Bouton pour ouvrir le modal de cr√©ation -->
<div class="mb-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newLandingPageModal">‚ûï Nouvelle Page de destination</button>
</div>

<!-- Table des landing pages -->
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr><th>Nom</th><th class="text-end"></th></tr>
        </thead>
        <tbody id="landingPageTableBody">
            {% for page in landing_pages %}
            <tr data-id="{{ page.id }}">
                <td>{{ page.name }}</td>
                <td class="text-end">
                    <button class="btn btn-primary btn-sm edit-landing-page" data-id="{{ page.id }}" data-bs-toggle="modal" data-bs-target="#editLandingPageModal">‚úèÔ∏è Modifier</button>
                    <button class="btn btn-danger btn-sm delete-landing-page" data-id="{{ page.id }}">üóëÔ∏è Supprimer</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ========== MODAL: CR√âER UNE NOUVELLE LANDING PAGE ========== -->
<div class="modal fade" id="newLandingPageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Cr√©er une Page de Destination</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Nom de la landing page -->
                <label for="newLandingPageName" class="form-label">Nom :</label>
                <input type="text" id="newLandingPageName" class="form-control mb-2" required>

                <!-- Section Importer un site -->
                <div class="border p-2 mb-3">
                    <h6 class="mb-2">Importer un site</h6>
                    <label for="importSiteURL" class="form-label">URL du site :</label>
                    <input type="text" id="importSiteURL" class="form-control" placeholder="http://example.com">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="includeResources">
                        <label class="form-check-label" for="includeResources">
                            Inclure les ressources (ajouter un tag &lt;base&gt;)
                        </label>
                    </div>
                    <button class="btn btn-info btn-sm mt-2" type="button" onclick="importSite()">Importer</button>
                </div>

                <!-- Code HTML de la landing page -->
                <label for="newLandingPageHTML" class="form-label">HTML :</label>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <!-- Le bouton bascule l'affichage entre le textarea et l'iframe de preview -->
                    <button class="btn btn-secondary btn-sm" onclick="togglePreview('newLandingPageHTML', 'previewNewPageFrame')" type="button">Vue/Code</button>
                </div>
                <textarea id="newLandingPageHTML" class="form-control" rows="5" required></textarea>
                <!-- Utilisation d'un iframe pour isoler le rendu -->
                <iframe id="previewNewPageFrame" style="display:none; width:100%; height:300px; border:1px solid #ccc;"></iframe>

                <!-- Options suppl√©mentaires -->
                <label class="form-label mt-2">Capture des donn√©es :</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="newCaptureCredentials" checked>
                    <label class="form-check-label" for="newCaptureCredentials">
                        Activer la capture des donn√©es
                    </label>
                </div>

                <label class="form-label mt-2">Capture des mots de passe :</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="newCapturePasswords">
                    <label class="form-check-label" for="newCapturePasswords">
                        Capturer √©galement les mots de passe
                    </label>
                </div>

                <label for="newRedirectUrl" class="form-label mt-2">URL de redirection :</label>
                <input type="text" id="newRedirectUrl" class="form-control" placeholder="http://example.com">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="submitNewLandingPage()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Le modal de modification reste inchang√© -->
<!-- ========== MODAL: MODIFIER UNE LANDING PAGE ========== -->
<div class="modal fade" id="editLandingPageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Modifier une Page de destination</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLandingPageId">
                <label for="editLandingPageName" class="form-label">Nom :</label>
                <input type="text" id="editLandingPageName" class="form-control mb-2" required>
                <label for="editLandingPageHTML" class="form-label">HTML :</label>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <button class="btn btn-secondary btn-sm" onclick="togglePreview('editLandingPageHTML', 'previewEditPageFrame')" type="button">Vue/Code</button>
                </div>
                <textarea id="editLandingPageHTML" class="form-control" rows="5" required></textarea>
                <iframe id="previewEditPageFrame" style="display:none; width:100%; height:300px; border:1px solid #ccc;"></iframe>
                
                <!-- Options suppl√©mentaires -->
                <label class="form-label mt-2">Capture des donn√©es :</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="editCaptureCredentials" checked>
                    <label class="form-check-label" for="editCaptureCredentials">
                        Activer la capture des donn√©es
                    </label>
                </div>
                <label class="form-label mt-2">Capture des mots de passe :</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="editCapturePasswords">
                    <label class="form-check-label" for="editCapturePasswords">
                        Capturer √©galement les mots de passe
                    </label>
                </div>
                <label for="editRedirectUrl" class="form-label mt-2">URL de redirection :</label>
                <input type="text" id="editRedirectUrl" class="form-control" placeholder="http://example.com">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitEditedLandingPage()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Charger les landing pages via l'API
    fetch('/api/gophish/landing_pages')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById("landingPageTableBody");
            tbody.innerHTML = "";
            data.forEach(page => {
                tbody.innerHTML += `
                    <tr data-id="${page.id}">
                        <td>${page.name}</td>
                        <td class="text-end">
                            <button class="btn btn-primary btn-sm edit-landing-page" data-id="${page.id}" data-bs-toggle="modal" data-bs-target="#editLandingPageModal">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-danger btn-sm delete-landing-page" data-id="${page.id}">üóëÔ∏è Supprimer</button>
                        </td>
                    </tr>
                `;
            });
            assignEditEvents();
            assignDeleteEvents();
        });
});

function assignEditEvents() {
    document.querySelectorAll(".edit-landing-page").forEach(btn => {
        btn.addEventListener("click", function() {
            const pageId = this.getAttribute("data-id");
            fetch(`/api/gophish/landing_pages/${pageId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("editLandingPageId").value = data.id;
                    document.getElementById("editLandingPageName").value = data.name;
                    document.getElementById("editLandingPageHTML").value = data.html;
                    document.getElementById("editCaptureCredentials").checked = data.capture_credentials;
                    document.getElementById("editCapturePasswords").checked = data.capture_passwords;
                    document.getElementById("editRedirectUrl").value = data.redirect_url || "";
                })
                .catch(err => console.error("Erreur lors du chargement de la page :", err));
        });
    });
}

function assignDeleteEvents() {
    document.querySelectorAll(".delete-landing-page").forEach(btn => {
        btn.addEventListener("click", function() {
            const pageId = this.getAttribute("data-id");
            Swal.fire({
                title: "Supprimer cette page ?",
                text: "Cette action est irr√©versible.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#6c757d",
                confirmButtonText: "Oui, supprimer",
                cancelButtonText: "Annuler",
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/gophish/landing_pages/${pageId}`, { method: "DELETE" })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                Swal.fire("Erreur", "Suppression impossible.", "error");
                            } else {
                                Swal.fire({
                                    title: "Supprim√©e !",
                                    text: "La page a √©t√© supprim√©e.",
                                    icon: "success",
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => { location.reload(); });
                            }
                        })
                        .catch(err => {
                            console.error("Erreur :", err);
                            Swal.fire("Erreur", "Probl√®me lors de la suppression.", "error");
                        });
                }
            });
        });
    });
}

function togglePreview(textareaId, iframeId) {
    const textarea = document.getElementById(textareaId);
    const iframe = document.getElementById(iframeId);

    if (iframe.style.display === "none") {
        iframe.srcdoc = textarea.value;
        iframe.style.display = "block";
        textarea.style.display = "none";
    } else {
        iframe.style.display = "none";
        textarea.style.display = "block";
    }
}

function validateLandingPageForm(nameId, htmlId) {
    const name = document.getElementById(nameId).value.trim();
    const html = document.getElementById(htmlId).value.trim();

    // Indiquer le nom des champs requis
    const isValidRequiredFields = validateRequiredFields([
        [name, "Nom Page de destination"],
        [html, "Contenu HTML"]
    ]);

    if (!isValidRequiredFields) return;

    return true;
}

// Cr√©ation d'une nouvelle landing page
function submitNewLandingPage() {
    if (!validateLandingPageForm("newLandingPageName", "newLandingPageHTML")) return;

    const data = {
        name: document.getElementById("newLandingPageName").value,
        html: document.getElementById("newLandingPageHTML").value,
        capture_credentials: document.getElementById("newCaptureCredentials").checked,
        capture_passwords: document.getElementById("newCapturePasswords").checked,
        redirect_url: document.getElementById("newRedirectUrl").value.trim() || null
    };

    fetch("/api/gophish/landing_pages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.error) {
            Swal.fire({ icon: "error", title: "Erreur", text: response.error, confirmButtonColor: "#d33" });
        } else {
            Swal.fire({ icon: "success", title: "Cr√©√©e !", text: "La page a √©t√© ajout√©e.", confirmButtonColor: "#28a745" })
            .then(() => { location.reload(); });
        }
    })
    .catch(err => {
        console.error("Erreur:", err);
        Swal.fire({ icon: "error", title: "Erreur serveur", text: "Une erreur s'est produite.", confirmButtonColor: "#d33" });
    });
}

// Modification d'une landing page
function submitEditedLandingPage() {
    if (!validateLandingPageForm("editLandingPageName", "editLandingPageHTML")) return;

    const pageId = document.getElementById("editLandingPageId").value;
    const data = {
        id: parseInt(pageId, 10),
        name: document.getElementById("editLandingPageName").value,
        html: document.getElementById("editLandingPageHTML").value,
        capture_credentials: document.getElementById("editCaptureCredentials").checked,
        capture_passwords: document.getElementById("editCapturePasswords").checked,
        redirect_url: document.getElementById("editRedirectUrl").value.trim() || null
    };

    fetch(`/api/gophish/landing_pages/${pageId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.error) {
            Swal.fire({ icon: "error", title: "Erreur", text: response.error, confirmButtonColor: "#d33" });
        } else {
            Swal.fire({ icon: "success", title: "Mise √† jour r√©ussie !", text: "La page a √©t√© modifi√©e.", confirmButtonColor: "#28a745" })
            .then(() => { location.reload(); });
        }
    })
    .catch(err => {
        console.error("Erreur:", err);
        Swal.fire({ icon: "error", title: "Erreur serveur", text: "Une erreur s'est produite.", confirmButtonColor: "#d33" });
    });
}

// R√©initialiser le formulaire lorsque le modal de cr√©ation est ferm√©
document.getElementById('newLandingPageModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById("newLandingPageName").value = "";
    document.getElementById("newLandingPageHTML").value = "";
    document.getElementById("newRedirectUrl").value = "";
    document.getElementById("newCaptureCredentials").checked = true;
    document.getElementById("newCapturePasswords").checked = false;
    document.getElementById("importSiteURL").value = "";
    document.getElementById("includeResources").checked = false;
    // R√©initialiser l'affichage de l'aper√ßu
    document.getElementById("previewNewPageFrame").style.display = "none";
    document.getElementById("newLandingPageHTML").style.display = "block";
});

function importSite() {
    const url = document.getElementById("importSiteURL").value.trim();
    const includeResources = document.getElementById("includeResources").checked;

    const isValidRequiredFields = validateRequiredFields([
        [url, "URL du site"],
        [html, "Contenu HTML"]
    ]);
    if (!isValidRequiredFields) return;


    const data = {
        url: url,
        include_resources: includeResources
    };

    fetch("/import_site", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.error) {
            Swal.fire({
                icon: "error",
                title: "Erreur lors de l'import",
                text: response.error,
                confirmButtonColor: "#d33"
            });
        } else {
            let finalHTML = response.html;
            if (includeResources) {
                // Si l'option d'inclusion des ressources est coch√©e,
                // on ajuste le href de la balise <base> pour qu'il corresponde √† l'URL import√©e.
                //finalHTML = adjustBaseUrl(finalHTML, url);
                // Vous pouvez √©ventuellement v√©rifier si le site est compatible en testant le contenu de la balise <base>
                if (!finalHTML.includes(`href="${url}"`)) {
                    Swal.fire({
                        icon: "error",
                        title: "Erreur lors de l'import",
                        text: "Ce site n'est pas compatible avec l'import des ressources.",
                        confirmButtonColor: "#d33"
                    });
                    return;
                }
            } else {
                // Si on n'inclut pas les ressources, on peut nettoyer le HTML en retirant la balise <base>.
                finalHTML = finalHTML.replace(/<base[^>]*>/gi, '');
            }
            document.getElementById("newLandingPageHTML").value = finalHTML;
            Swal.fire({
                icon: "success",
                title: "Site import√© avec succ√®s !",
                text: "Le code HTML a √©t√© r√©cup√©r√©. Vous pouvez le modifier si n√©cessaire.",
                confirmButtonColor: "#28a745"
            });
        }
    })
    .catch(err => {
        console.error("Erreur:", err);
        Swal.fire({
            icon: "error",
            title: "Erreur serveur",
            text: "Une erreur s'est produite lors de l'import du site.",
            confirmButtonColor: "#d33"
        });
    });
}

</script>
{% endblock %}
