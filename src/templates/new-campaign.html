{% extends "index.html" %}
{% block title %}Create a New Campaign - SmartPhish{% endblock %}

{% block content %}
<h2>ðŸš€ Create a New Phishing Campaign</h2>

<form id="campaignForm">
  <div class="mb-3">
    <label for="campaignName" class="form-label">Campaign Name:</label>
    <input type="text" id="campaignName" class="form-control" required>
  </div>

  <div class="mb-3">
    <label for="campaignGroups" class="form-label">Select Target Groups:</label>
    <select id="campaignGroups" class="form-select" multiple required>
      {% for group in groups %}
        <option value="{{ group.name }}">{{ group.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="campaignTemplate" class="form-label">Select Email Template:</label>
    <select id="campaignTemplate" class="form-select" required>
      {% for template in templates %}
        <option value="{{ template.name }}">{{ template.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="campaignLandingPage" class="form-label">Select Landing Page:</label>
    <select id="campaignLandingPage" class="form-select" required>
      {% for page in pages %}
        <option value="{{ page.name }}">{{ page.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="campaignSmtp" class="form-label">Select Sending Profile:</label>
    <select id="campaignSmtp" class="form-select" required>
      {% for smtp in sending_profiles %}
        <option value="{{ smtp.name }}">{{ smtp.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="campaignLaunchDate" class="form-label">Launch Date:</label>
    <input type="datetime-local" id="campaignLaunchDate" class="form-control">
  </div>

  <div class="mb-3">
    <label for="campaignUrl" class="form-label">Phishing URL:</label>
    <input type="url" id="campaignUrl" class="form-control" value="http://localhost">
  </div>

  <button type="button" class="btn btn-success" onclick="submitCampaign()">ðŸš€ Launch Campaign</button>
</form>

<script>
  function submitCampaign() {
    const data = {
      name: document.getElementById("campaignName").value,
      groups: Array.from(document.getElementById("campaignGroups").selectedOptions).map(option => ({ name: option.value })),
      template: { name: document.getElementById("campaignTemplate").value },
      page: { name: document.getElementById("campaignLandingPage").value },
      smtp: { name: document.getElementById("campaignSmtp").value },
      launch_date: document.getElementById("campaignLaunchDate").value,
      url: document.getElementById("campaignUrl").value
    };

    fetch("/new-campaign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
      if (response.error) {
        alert("Error: " + response.error);
      } else {
        alert("âœ… Campaign created successfully!");
        window.location.href = "/follow-campaign"; // Rediriger vers la liste des campagnes
      }
    })
    .catch(err => console.error(err));
  }
</script>

{% endblock %}
